"use strict";var music=angular.module("music",[]);music.config(["$httpProvider",function(e){e.interceptors.push("RequestInjector")}]),music.controller("RootController",["$rootScope","$scope","$timeout","MusicService","AlertService",function(e,t,n,o,r){e.$on("loading",function(t,n){e.loading=!0,e.whenLoadingText=n}),t.playing=!1,t.hasPrev=!1,t.hasNext=!1,t.song={},t.list={},t.keyword="",t.playMode=1,t.progressW=document.querySelector(".dc-progress-bar").clientWidth,t.progress=0;var i=document.getElementById("fr").contentWindow.document.getElementById("audio");i.addEventListener("play",function(){t.$apply(function(){t.playing=!0})},!1),i.addEventListener("pause",function(){t.$apply(function(){t.playing=!1})},!1),i.addEventListener("ended",function(){1==t.playMode?t.hasNext?t.next():t.load(t.list[0]):t.load(t.song,!0)},!1),i.addEventListener("timeupdate",function(e){var n=parseInt(e.target.currentTime);t.Animatelrc(n),t.$apply(function(){t.song.currentTime=n,t.progress=n/t.song.time})},!1),t.$watch("playMode",function(e,t){e?r.add("success","列表循环",1e3):r.add("success","单曲循环",1e3)}),t.JudgePos=function(e){var n=0,o=t.list.length-1;t.hasPrev=e>n,t.hasNext=o>e},t.search=function(){t.$emit("loading","搜索"+t.keyword);var e=o.search(t.keyword);e.then(function(e){t.loading=!1,null==e||e.error?r.add("warning","没有找到相关结果",500):(t.loading=!1,t.common=e.common,t.list=e.list)},function(e){t.loading=!1,r.add("warning","没有找到相关结果",500)})},t.load=function(e,n){if(e.id!=t.song.id){t.$emit("loading","加载"+e.title);var c=o.base(e.id);c.then(function(n){t.JudgePos(Array.prototype.indexOf.call(t.list,e)),t.song=e,t.loading=!1,t.song.img=n.img,t.song.author=n.author,t.song.title=n.title,t.song.time=n.time,t.song.currentTime=0,t.song.src=n.audio,i.src=n.audio,t.Getlrc(t.song.id),r.add("info",t.song.author+" - "+t.song.title,500),i.play()},function(e){t.loading=!1,r.add("warning","加载歌曲出错",500)})}else i.play()},t.Getlrc=function(e){var n=o.lrc(e),r="";n.then(function(e){for(var n in e)r+='<div data-timeline="'+e[n].time+'">'+e[n].text+"</div>";t.song.lrc=r},function(e){t.song.lrc=e})},t.Animatelrc=function(e){var t=document.querySelectorAll("[data-timeline]"),n=0,o=0,r={i:0,time:0};for(var i in t){var c=t[i];if(void 0!=c.dataset){var s=parseInt(c.dataset.timeline);if(s==e){o=c.clientHeight,c.className="current",r.i=parseInt(i)+1;try{r.time=t[r.i].dataset.timeline}catch(a){}if(r.time>0){var u=r.time-s;!function(e){setTimeout(function(){t[e].className=""},1e3*u)}(i)}document.querySelector(".lrc>.content").style.marginTop=-(n-o)+"px"}else e>s&&(n+=c.clientHeight)}}},t.Getlist=function(e){t.$emit("loading","加载中");var n=o.list(e,0,40);n.then(function(e){t.common=e.common,t.list=e.list},function(e){r.add("warning","加载歌曲出错",500)})},t.download=function(e){var t=o.download(e.id);t.then(function(e){console.log("下载成功")},function(e){console.log("下载失败")})},t.play=function(){i.play()},t.pause=function(){i.pause()},t.prev=function(){var e=Array.prototype.indexOf.call(t.list,t.song);t.load(t.list[--e])},t.next=function(){var e=Array.prototype.indexOf.call(t.list,t.song);t.load(t.list[++e])}}]),music.directive("dcToggle",[function(){return{restrict:"EA",link:function(e,t,n){}}}]),music.directive("dcProgressBar",[function(){return{link:function(e,t,n){var o=document.getElementById("fr").contentWindow.document.getElementById("audio");t.bind("click",function(n){var r=t[0].getBoundingClientRect(),i=r.left,c=n.x,s=(c-i)/r.width;s=s>1?1:s;var a=e.song.time,u=a*s;o.currentTime=u,e.song.currentTime=u})}}}]),music.filter("formatTime",[function(){return function(e){e=parseInt(e)||0;var t=0,n=0;return e>60?(t=parseInt(e/60),n=e-60*t,t=t>=10?t:"0"+t,n=n>=10?n:"0"+n):(t="00",n=e>=10?e:"0"+e),t+":"+n}}]),music.filter("trust_as_html",["$sce",function(e){return function(t){return e.trustAsHtml(t)}}]),music.filter("image_default_avatar",[function(){return function(e){if(null==e||""==e){var t="http://127.0.0.1:3000";return t+"/image/avatar/default.jpeg"}return e}}]),music.factory("RequestInjector",["$rootScope",function(e){return{request:function(t){return e.loading=!0,t.requestTimestamp=(new Date).getTime(),console.log(t),t},response:function(t){return e.loading=!1,t.config.responseTimestamp=(new Date).getTime(),console.log(t.config),t}}}]),music.factory("MusicService",["$http","$q",function(e,t){return{list:function(n,o,r){var i=t.defer();return e.get("api/list?type="+n+"&size="+r+"&offset="+o,{cache:!0}).success(function(e,t,n,o){var r=o.responseTimestamp-o.requestTimestamp;console.log("The list request took "+r/1e3+" seconds."),i.resolve(e)}).error(function(e){i.reject(e)}),i.promise},base:function(n){var o=t.defer();return e.get("api/song?song_id="+n).success(function(e,t,n,r){e.error?o.reject(e.error):o.resolve(e)}).error(function(e){o.reject("加载出错")}),o.promise},lrc:function(n){var o=t.defer();return e.get("api/lrc?songId="+n,{cache:!0}).success(function(e,t,n,r){e.error?o.reject(e.error):o.resolve(e)}).error(function(e){o.reject("加载歌词出错")}),o.promise},search:function(n){var o=t.defer();return e.get("api/search?keyword="+n).success(function(e,t,n,r){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise},download:function(n){var o=t.defer();return e.get("api/download?song_id="+n).success(function(e,t,n,r){o.resolve(e)}).error(function(e){o.reject(e)}),o.promise}}}]),music.factory("AlertService",["$rootScope","$timeout",function(e,t){var n={};return e.alerts=[],n.add=function(o,r,i){e.alerts.push({type:o,msg:r,close:function(){n.closeAlert(this)}}),i&&t(function(){e.alerts=[]},i)},n.closeAlert=function(t){n.closeAlertIdx(e.alerts.indexOf(t))},n.closeAlertIdx=function(t){e.alerts.splice(t,1)},n}]);